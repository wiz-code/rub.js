/*! For license information please see rub.min.js.LICENSE.txt */
!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Rub=e():t.Rub=e()}(self,(function(){return function(){var t={"./node_modules/javascript-state-machine/state-machine.js":function(t,e){var n;n={VERSION:"2.4.0",Result:{SUCCEEDED:1,NOTRANSITION:2,CANCELLED:3,PENDING:4},Error:{INVALID_TRANSITION:100,PENDING_TRANSITION:200,INVALID_CALLBACK:300},WILDCARD:"*",ASYNC:"async",create:function(t,e){var r="string"==typeof t.initial?{state:t.initial}:t.initial,s=t.terminal||t.final,i=e||t.target||{},a=t.events||[],o=t.callbacks||{},c={},u={},l=function(t){var e=Array.isArray(t.from)?t.from:t.from?[t.from]:[n.WILDCARD];c[t.name]=c[t.name]||{};for(var r=0;r<e.length;r++)u[e[r]]=u[e[r]]||[],u[e[r]].push(t.name),c[t.name][e[r]]=t.to||e[r];t.to&&(u[t.to]=u[t.to]||[])};r&&(r.event=r.event||"startup",l({name:r.event,from:"none",to:r.state}));for(var d=0;d<a.length;d++)l(a[d]);for(var h in c)c.hasOwnProperty(h)&&(i[h]=n.buildEvent(h,c[h]));for(var h in o)o.hasOwnProperty(h)&&(i[h]=o[h]);return i.current="none",i.is=function(t){return Array.isArray(t)?t.indexOf(this.current)>=0:this.current===t},i.can=function(t){return!this.transition&&void 0!==c[t]&&(c[t].hasOwnProperty(this.current)||c[t].hasOwnProperty(n.WILDCARD))},i.cannot=function(t){return!this.can(t)},i.transitions=function(){return(u[this.current]||[]).concat(u[n.WILDCARD]||[])},i.isFinished=function(){return this.is(s)},i.error=t.error||function(t,e,n,r,s,i,a){throw a||i},i.states=function(){return Object.keys(u).sort()},r&&!r.defer&&i[r.event](),i},doCallback:function(t,e,r,s,i,a){if(e)try{return e.apply(t,[r,s,i].concat(a))}catch(e){return t.error(r,s,i,a,n.Error.INVALID_CALLBACK,"an exception occurred in a caller-provided callback function",e)}},beforeAnyEvent:function(t,e,r,s,i){return n.doCallback(t,t.onbeforeevent,e,r,s,i)},afterAnyEvent:function(t,e,r,s,i){return n.doCallback(t,t.onafterevent||t.onevent,e,r,s,i)},leaveAnyState:function(t,e,r,s,i){return n.doCallback(t,t.onleavestate,e,r,s,i)},enterAnyState:function(t,e,r,s,i){return n.doCallback(t,t.onenterstate||t.onstate,e,r,s,i)},changeState:function(t,e,r,s,i){return n.doCallback(t,t.onchangestate,e,r,s,i)},beforeThisEvent:function(t,e,r,s,i){return n.doCallback(t,t["onbefore"+e],e,r,s,i)},afterThisEvent:function(t,e,r,s,i){return n.doCallback(t,t["onafter"+e]||t["on"+e],e,r,s,i)},leaveThisState:function(t,e,r,s,i){return n.doCallback(t,t["onleave"+r],e,r,s,i)},enterThisState:function(t,e,r,s,i){return n.doCallback(t,t["onenter"+s]||t["on"+s],e,r,s,i)},beforeEvent:function(t,e,r,s,i){if(!1===n.beforeThisEvent(t,e,r,s,i)||!1===n.beforeAnyEvent(t,e,r,s,i))return!1},afterEvent:function(t,e,r,s,i){n.afterThisEvent(t,e,r,s,i),n.afterAnyEvent(t,e,r,s,i)},leaveState:function(t,e,r,s,i){var a=n.leaveThisState(t,e,r,s,i),o=n.leaveAnyState(t,e,r,s,i);return!1!==a&&!1!==o&&(n.ASYNC===a||n.ASYNC===o?n.ASYNC:void 0)},enterState:function(t,e,r,s,i){n.enterThisState(t,e,r,s,i),n.enterAnyState(t,e,r,s,i)},buildEvent:function(t,e){return function(){var r=this.current,s=e[r]||(e[n.WILDCARD]!=n.WILDCARD?e[n.WILDCARD]:r)||r,i=Array.prototype.slice.call(arguments);if(this.transition)return this.error(t,r,s,i,n.Error.PENDING_TRANSITION,"event "+t+" inappropriate because previous transition did not complete");if(this.cannot(t))return this.error(t,r,s,i,n.Error.INVALID_TRANSITION,"event "+t+" inappropriate in current state "+this.current);if(!1===n.beforeEvent(this,t,r,s,i))return n.Result.CANCELLED;if(r===s)return n.afterEvent(this,t,r,s,i),n.Result.NOTRANSITION;var a=this;this.transition=function(){return a.transition=null,a.current=s,n.enterState(a,t,r,s,i),n.changeState(a,t,r,s,i),n.afterEvent(a,t,r,s,i),n.Result.SUCCEEDED},this.transition.cancel=function(){a.transition=null,n.afterEvent(a,t,r,s,i)};var o=n.leaveState(this,t,r,s,i);return!1===o?(this.transition=null,n.Result.CANCELLED):n.ASYNC===o?n.Result.PENDING:this.transition?this.transition():void 0}}},t.exports&&(e=t.exports=n),e.StateMachine=n},"./src/index.ts":function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return h}});var r=n("./node_modules/javascript-state-machine/state-machine.js"),s=n.n(r),i=n("./src/modules/mouse-handler.ts"),a=n("./src/modules/touch-handler.ts"),o=n("./src/modules/recorder.ts"),c=n("./src/modules/dataset.ts");const{abs:u,max:l}=Math;let d=0;class h{constructor(t,e){this.container=t,this.bounds=new Map,this.inputId=0,this.outputId=0,this.loopCallbacks=[],this.offset=0,this.t0=0,this.x0=0,this.y0=0,this.id=(d+=1,d);const n=this.container.querySelector(".rb-bounds"),r=Array.from(n.children);for(let t=0,e=r.length;t<e;t+=1){const e=r[t],n=e.dataset.boundsType;if(null==n)throw new Error("cannot find identified class name");const s=e.childElementCount>0?Array.from(e.children):[e],c="ontouchstart"in window||navigator.maxTouchPoints>0||navigator.msMaxTouchPoints>0?a.default:i.default;this.bounds.set(n,{recorder:new o.default(s),event:new c(s)})}const[h]=Array.from(this.bounds.keys()),f=this.bounds.get(h);this.currentBoundsType=h,this.recorder=f.recorder,this.event=f.event,this.event.addListeners(this.container),this.media=s().create(c.default.media),null!=e&&this.addLoopCallback(e),this.output=()=>{if(this.loopCallbacks.length>0){const t=this.recorder.getFrames();for(let e=0,n=this.loopCallbacks.length;e<n;e+=1)this.loopCallbacks[e](t)}this.outputId=requestAnimationFrame(this.output)},this.input=t=>{let e=0,n=-1;if(this.event.isAttached()){const t=this.event.getEventTrackCount();if(t>this.offset){const n=this.event.getEventTrack(),[r,s,i]=Array.from(n);if(this.t0>0){const t=r-this.t0,n=s-this.x0,a=i-this.y0;t>4&&(e=function(t,e,n){return t>0?l(u(e/t),u(n/t)):0}(t,n,a))}this.t0=r,this.x0=s,this.y0=i,this.offset=t}n=this.event.getActiveTargetIndex()}this.recorder.update(t,e,n),this.inputId=requestAnimationFrame(this.input)}}getId(){return this.id}startLoop(){this.inputId=requestAnimationFrame(this.input),this.outputId=requestAnimationFrame(this.output)}stopLoop(){this.recorder.suspend(),cancelAnimationFrame(this.inputId),cancelAnimationFrame(this.outputId)}clearLoop(){this.t0=0,this.x0=0,this.y0=0,this.offset=0,this.resetBoundsType()}getCurrentBoundsType(){return this.currentBoundsType}setBoundsType(t){const e=this.bounds.get(t);if(null==e)throw new Error("this is assigned undefined");this.currentBoundsType=t,this.resetBoundsType(),this.removeEventHandler(),this.recorder=e.recorder,this.event=e.event,this.setEventHandler()}setMediaCallback(t){Object.assign(this.media,t)}addLoopCallback(t){if(Array.isArray(t))for(let e=0,n=t.length;e<n;e+=1)this.loopCallbacks.push(t[e].bind(this));else this.loopCallbacks.push(t.bind(this))}clearLoopCallback(){this.loopCallbacks.length=0}setEventHandler(){this.event.isAttached()||this.event.addListeners(this.container)}removeEventHandler(){this.event.isAttached()&&this.event.removeListeners(this.container)}resetBoundsType(){this.event.clearEventTracks(),this.recorder.resetFrames()}}},"./src/modules/dataset.ts":function(t,e,n){"use strict";n.r(e);e.default={pointer:{initial:"created",events:[{name:"initialize",from:"created",to:"idling"},{name:"start",from:"idling",to:"running"},{name:"end",from:"running",to:"idling"}]},target:{initial:"created",events:[{name:"initialize",from:"created",to:"inactive"},{name:"activate",from:"inactive",to:"active"},{name:"inactivate",from:"active",to:"inactive"}]},media:{initial:"created",events:[{name:"initialize",from:"created",to:"initialized"},{name:"ready",from:"initialized",to:"idling"},{name:"reset",from:["idling","error"],to:"initialized"},{name:"start",from:"idling",to:"running"},{name:"stop",from:"running",to:"idling"},{name:"pause",from:"running",to:"pending"},{name:"resume",from:"pending",to:"running"},{name:"quit",from:"pending",to:"idling"},{name:"abort",from:"*",to:"error"}]}}},"./src/modules/event-type.ts":function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return r}});class r{}r.MouseDown="mousedown",r.MouseUp="mouseup",r.MouseMove="mousemove",r.MouseEnter="mouseenter",r.MouseLeave="mouseleave",r.Click="click",r.DoubleClick="dblclick",r.ContextMenu="contextmenu",r.TouchStart="touchstart",r.TouchEnd="touchend",r.TouchMove="touchmove",r.TouchCancel="touchcancel"},"./src/modules/mouse-handler.ts":function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return a}});var r=n("./src/modules/pointer-handler.ts"),s=n("./src/modules/event-type.ts");const{documentElement:i}=document;class a extends r.default{constructor(t){super(t),this.listener={start:a.start.bind(this,this.state),end:a.end.bind(this,this.state),move:a.move.bind(this,this.state),activate:a.activate.bind(this),inactivate:a.inactivate.bind(this)}}addListeners(t){if(null!=this.listener){this.attached=!0,t.addEventListener(s.default.MouseDown,this.listener.start,!1),t.addEventListener(s.default.MouseMove,this.listener.move,!1),t.addEventListener(s.default.MouseUp,this.listener.end,!1);for(let t=0,e=this.targets.length;t<e;t+=1){const e=this.targets[t];e.el.addEventListener(s.default.MouseEnter,this.listener.activate,!1),e.el.addEventListener(s.default.MouseLeave,this.listener.inactivate,!1)}}}removeListeners(t){if(null!=this.listener){this.attached=!1,t.removeEventListener(s.default.MouseDown,this.listener.start,!1),t.removeEventListener(s.default.MouseMove,this.listener.move,!1),t.removeEventListener(s.default.MouseUp,this.listener.end,!1);for(let t=0,e=this.targets.length;t<e;t+=1){const e=this.targets[t];e.el.removeEventListener(s.default.MouseEnter,this.listener.activate,!1),e.el.removeEventListener(s.default.MouseLeave,this.listener.inactivate,!1)}}}static start(t,e){if(!(e instanceof MouseEvent))return;if("idling"!==t.current)return;t.start();const n=performance.now(),r=i.getBoundingClientRect(),s=e.clientX-r.left,a=e.clientY-r.top;this.coords.addTrack([n,s,a])}static move(t,e){if(!(e instanceof MouseEvent))return;if("running"!==t.current)return;const n=performance.now(),r=i.getBoundingClientRect(),s=e.clientX-r.left,a=e.clientY-r.top;this.coords.addTrack([n,s,a])}static end(t,e){if(!(e instanceof MouseEvent))return;if("running"!==t.current)return;const n=performance.now(),r=i.getBoundingClientRect(),s=e.clientX-r.left,a=e.clientY-r.top;this.coords.addTrack([n,s,a]),t.end()}static activate(t){const e=this.findTargetIndex((e=>e.el===t.target)),n=this.targets[e];null!=n&&"inactive"===n.state.current&&n.state.activate()}static inactivate(t){const e=this.findTargetIndex((e=>e.el===t.target)),n=this.targets[e];null!=n&&"active"===n.state.current&&n.state.inactivate()}}},"./src/modules/pointer-handler.ts":function(t,e,n){"use strict";n.r(e);var r=n("./node_modules/javascript-state-machine/state-machine.js"),s=n("./src/modules/target.ts"),i=n("./src/modules/tracker.ts"),a=n("./src/modules/dataset.ts");const o=t=>t.isActive();e.default=class{constructor(t){this.attached=!1,this.targets=t.map((t=>{const e=new s.default(t);return e.state.initialize(),e})),this.state=r.StateMachine.create(a.default.pointer),this.state.initialize(),this.coords=new i.default(9e5,3),this.listener={}}findTargetIndex(t){let e=-1;for(let n=0,r=this.targets.length;n<r;n+=1){if(t(this.targets[n])){e=n;break}}return e}getActiveTargetIndex(){return this.findTargetIndex(o)}getEventTrackCount(){return this.coords.count}getEventTrack(){return this.coords.getTrack()}clearEventTracks(){return this.coords.clearTracks()}isAttached(){return this.attached}}},"./src/modules/recorder.ts":function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return a}});var r=n("./src/modules/tracker.ts");const s=1e3/60,{round:i}=Math;class a{constructor(t){this.frames=0,this.started=!1,this.elapsedTime=0,this.lastTime=0;const e=t.length;this.blockSize=e+1,this.record=new Map([["live",this.createRecord()],["playback",this.createRecord()],["external",this.createRecord()]]),this.shiftedFrames={live:0,playback:0,external:0},this.template=Array(e+1).fill(0)}update(t,e,n){const r=this.template.slice(0),a=this.record.get("live");if(this.started){this.elapsedTime+=t-this.lastTime,this.lastTime=t;const o=i(this.elapsedTime/s);o>this.frames&&(this.frames=o,r[0]=this.frames,n>-1&&(r[n+1]=e),a.setTrack(r,this.frames))}else this.started=!0,this.lastTime=t,r[0]=this.frames,a.setTrack(r,this.frames)}createRecord(){const t=new r.default(216e3,this.blockSize);return t.writeFrames(),t}getElapsedTime(){return this.elapsedTime}getFrames(){return this.frames}setFrames(t){const e=this.template.slice(0);e[0]=t,this.record.get("live").setTrack(e,t);const n=(t-this.frames)*s;this.elapsedTime+=n,this.frames=t}suspend(){this.started=!1}resetFrames(){this.frames=0,this.started=!1,this.lastTime=0,this.elapsedTime=0}clearRecord(t="live"){this.record.get(t).writeFrames()}getRecordCount(t="live"){return this.record.get(t).count}getVelocities(t=-1,e="live"){const n=t+this.shiftedFrames[e],r=this.record.get(e).getTrack(n);return Array.from(r.subarray(1))}getRecord(t="live"){const e=this.record.get(t);return e.getTrack(0,e.size)}setRecord(t,e="live"){this.record.get(e).setTrack(t)}addData(t){this.record.get("live").addTrack(t)}getData(t=-1,e=1,n="live"){const r=t+this.shiftedFrames[n];return this.record.get(n).getTrack(r,e)}setData(t,e=0,n="live"){this.record.get(n).setTrack(t,e)}setShiftedFrames(t,e="live"){this.shiftedFrames[e]=t}}},"./src/modules/target.ts":function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return i}});var r=n("./node_modules/javascript-state-machine/state-machine.js"),s=n("./src/modules/dataset.ts");class i{constructor(t){this.el=t,this.state=r.StateMachine.create(s.default.target)}isActive(){return"active"===this.state.current}}},"./src/modules/touch-handler.ts":function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return a}});var r=n("./src/modules/pointer-handler.ts"),s=n("./src/modules/event-type.ts");const{documentElement:i}=document;class a extends r.default{constructor(t){super(t),this.listener={start:a.start.bind(this,this.state),move:a.move.bind(this,this.state),end:a.end.bind(this,this.state)}}addListeners(t){null!=this.listener&&(this.attached||(this.attached=!0,t.addEventListener(s.default.TouchStart,this.listener.start,!1),t.addEventListener(s.default.TouchMove,this.listener.move,!1),t.addEventListener(s.default.TouchEnd,this.listener.end,!1),t.addEventListener(s.default.TouchCancel,this.listener.end,!1)))}removeListeners(t){null!=this.listener&&this.attached&&(this.attached=!1,t.removeEventListener(s.default.TouchStart,this.listener.start,!1),t.removeEventListener(s.default.TouchMove,this.listener.move,!1),t.removeEventListener(s.default.TouchEnd,this.listener.end,!1),t.removeEventListener(s.default.TouchCancel,this.listener.end,!1))}static start(t,e){if(!(e instanceof TouchEvent))return;if("idling"!==t.current)return;t.start();const n=performance.now(),r=i.getBoundingClientRect(),s=Array.from(e.changedTouches)[0],a=s.clientX-r.left,o=s.clientY-r.top;this.coords.addTrack([n,a,o])}static move(t,e){if(!(e instanceof TouchEvent))return;if("running"!==t.current)return;const n=performance.now(),r=i.getBoundingClientRect(),s=Array.from(e.changedTouches)[0],a=s.clientX,o=s.clientY,c=a-r.left,u=o-r.top;for(let t=0,e=this.targets.length;t<e;t+=1){const e=this.targets[t],n=e.el.getBoundingClientRect();a>=n.left&&a<=n.left+n.width&&o>=n.top&&o<=n.top+n.height?"active"!==e.state.current&&e.state.activate():"inactive"!==e.state.current&&e.state.inactivate()}this.coords.addTrack([n,c,u])}static end(t,e){if(!(e instanceof TouchEvent))return;if("running"!==t.current)return;const n=performance.now(),r=i.getBoundingClientRect(),s=Array.from(e.changedTouches)[0],a=s.clientX-r.left,o=s.clientY-r.top;this.coords.addTrack([n,a,o]),t.end()}}},"./src/modules/tracker.ts":function(t,e,n){"use strict";n.r(e),n.d(e,{default:function(){return s}});const{floor:r}=Math;class s{constructor(t,e){this.end=0,this.blockSize=e;try{this.tracks=new Float32Array(t*this.blockSize)}catch(t){throw new Error("cannot allocate memory")}if(!new Uint8Array(new Uint16Array([255]).buffer)[0])throw new Error("required little endian system")}get count(){return r(this.end/this.blockSize)}get size(){return r(this.tracks.length/this.blockSize)}setTrack(t,e=0){if(t.length%this.blockSize!=0)throw new Error("Track size not matched");const n=e*this.blockSize;this.tracks.set(t,n),n+t.length>=this.end&&(this.end=n+t.length)}addTrack(t){if(t.length%this.blockSize!=0)throw new Error("Track size not matched");this.tracks.set(t,this.end),this.end+=t.length}getTrack(t=-1,e=1){const n=t<0?(this.count+t)*this.blockSize:t*this.blockSize,r=n+e*this.blockSize;return this.tracks.subarray(n,r)}clearTracks(){this.end=0,this.tracks.fill(0)}writeFrames(){this.clearTracks();for(let t=0,e=this.tracks.length,n=0;t<e;t+=1)t%this.blockSize==0&&(this.tracks.set([n],t),n+=1)}static create(t,e){return new s(t,e)}}}},e={};function n(r){if(e[r])return e[r].exports;var s=e[r]={exports:{}};return t[r](s,s.exports,n),s.exports}return n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,{a:e}),e},n.d=function(t,e){for(var r in e)n.o(e,r)&&!n.o(t,r)&&Object.defineProperty(t,r,{enumerable:!0,get:e[r]})},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n("./src/index.ts")}()}));
//# sourceMappingURL=rub.min.js.map